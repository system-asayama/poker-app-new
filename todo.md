# Poker Game TODO

## AI機能実装 (完了)
- [x] データベーススキーマにAIプレイヤー情報を追加
- [x] AI戦略エンジンの実装（初級・中級・上級）
- [x] ゲーム作成時のAI追加オプション実装
- [x] AI自動プレイロジックの実装
- [x] フロントエンドのAI追加UI実装
- [x] ゲーム画面でのAIプレイヤー表示
- [x] AIの行動アニメーション実装（1.5秒待機）
- [x] PostgreSQL JSON型のパース問題修正

## ゲーム進行停止問題の修正
- [x] AIエンジン: チップ不足時のall-in判定を追加
- [x] AIエンジン: レイズ額が最小レイズ額を下回る場合の処理を追加
- [x] AIエンジン: コール額がチップを超える場合にall-inを返すように修正
- [x] processAITurn: エラー発生時のフォールバック処理を追加（check/fold）
- [x] processAITurn: エラー後も必ずcurrent_turnを更新するように修正
- [x] isBettingRoundComplete: 'bet'アクションを削除し'raise'のみに修正
- [x] performAction: レイズ額検証ロジックを改善
- [x] performAction: コール時のチップ不足処理を改善

## ハンド結果表示と観戦モード機能
- [x] フォールド後もゲーム進行を観戦できるようにする
- [x] 各ハンド終了時に勝者と役を表示する結果画面を追加
- [x] 結果画面に「次のハンドへ」ボタンを追加
- [x] showdown時に全プレイヤーの手札と役を表示
- [x] 複数ハンドゲームで各ハンドの結果を記録
- [x] ハンド間の待機画面を実装

## 「次のハンドへ」ボタンが表示されない問題
- [x] handleShowdownで最大ハンド数到達時にゲームを終了させないように修正
- [x] continueToNextHandで最大ハンド数到達を判定してゲームを終了するように修正
- [x] 1人残りの場合のみhandleShowdownでゲームを終了

## APIレスポンスにmaxHandsとcurrentHandが含まれていない問題
- [x] game.tsのGET /:gameIdエンドポイントでmaxHandsとcurrentHandをレスポンスに追加
- [x] winnersフィールドもレスポンスに追加

## 「次のハンドへ」ボタンが表示されない問題（デバッグ）
- [x] Game.tsxにデバッグログを追加してgame.statusとgame.currentPhaseを確認
- [x] 条件を一時的に緩和してボタンを強制表示
- [x] handleContinueToNextHandが正しく呼び出されるか確認

## continueToNextHandでゲームが誤って終了する問題
- [x] continueToNextHandにデバッグログを追加
- [x] playerCountとgame.current_handの値を確認
- [x] ゲーム終了条件を再確認

## 2ハンド目以降「次のハンドへ」ボタンが表示されない問題
- [x] startNextHandでcurrent_handが正しく更新されているか確認
- [x] current_handの更新タイミングを修正
- [x] デバッグログでcurrent_handの値を追跡

## 管理者パネル機能の再導入
- [x] Admin.tsxに各プレイヤーの成立役（HandRank）を表示する機能を追加
- [x] Admin.tsxに勝利予測（誰が勝つか）を表示する機能を追加
- [x] バックエンドAPIで全プレイヤーのハンド評価を計算する機能を追加
- [x] ローカル環境でテストして動作確認
- [x] GitHubにプッシュしてHerokuにデプロイ
- [x] 本番環境でブラウザテストを実施

## 最終的な勝者予測機能の改善
- [x] デッキから残りのコミュニティカードを取得して最終的な5枚を予測
- [x] 最終的なリバー状態での各プレイヤーの成立役を評価
- [x] 最終的な勝者を予測表示
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## ショーダウン時のコミュニティカードが変わるバグ
- [x] advancePhaseの再帰呼び出しでカードが追加される問題を発見
- [x] all-in時に一度に全てのカードを配るように修正
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## 管理者画面の成立役が誤って表示されるバグ
- [x] 管理者画面APIのハンド評価ロジックを調査
- [x] checkStraight関数のA-2-3-4-5判定バグを発見
- [x] A-2-3-4-5ストレートの正しい判定ロジックに修正
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## 勝者がポットのチップを獲得できないバグ
- [x] handleShowdownのチップ配分ロジックを調査
- [x] current_betが各ラウンドでリセットされる問題を発見
- [x] total_betカラムを追加して累積ベット額を追跡
- [x] ベット時にtotal_betを更新するように修正
- [x] handleShowdownでtotal_betを使用するように修正
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## ゲームが進まない（AIプレイヤーが応答しない）バグ
- [x] 自動マイグレーションスクリプトを作成
- [x] アプリ起動時に自動実行するように修正
- [ ] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## チップが0になったプレイヤーの自動除外機能
- [x] ハンド終了時にチップが0のプレイヤーを自動的にゲームから除外
- [x] 除外されたプレイヤーは次のハンドに参加できないようにする
- [x] 残りプレイヤーが1人になったらゲーム終了処理を追加
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## 管理者画面で除外プレイヤーの表示改善
- [x] status='out'のプレイヤーをグレーアウト表示
- [x] 除外されたプレイヤーに「チップ切れ」ラベルを追加
- [x] 除外されたプレイヤーのホールカードを非表示
- [x] 除外されたプレイヤーの成立役と勝利予測を非表示
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## ショーダウン画面で複数の勝者に🏆マークが表示されるバグ
- [x] Game.tsxのショーダウン表示ロジックを調査
- [x] 誤ったフォールバックロジック（最もチップが多いプレイヤーを勝者と判定）を削除
- [x] game.winnersのみを使用するように修正
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## チップがゼロのプレイヤーがいると次のハンドでプレイが止まるバグ
- [x] startNextHand関数のディーラーポジション計算を確認
- [x] ポジション番号と配列インデックスを混同していた問題を発見
- [x] 現在のディーラーポジションから配列インデックスを検索するように修正
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## 1回目のハンドでRiverフェーズ中にshowdown画面が表示されるバグ
- [x] フロントエンドのGame.tsxでshowdown画面表示条件を確認
- [x] Socket.IOの更新タイミングとloadGameState関数を調査
- [x] バックエンドとフロントエンドの状態同期問題を特定
- [x] 根本原因を修正（handleShowdown関数の最後にSocket.IOイベント発火を追加）
- [x] ローカル環境でテスト（データベース接続問題のためスキップ）
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## 「次のハンドへ」ボタンをクリックした時に画面が更新されない
- [x] continueToNextHand関数でSocket.IOイベントが発火されているか確認
- [x] フロントエンドのhandleContinueToNextHand関数を確認
- [x] 修正を実装（handleContinueToNextHandにフォールバックとしてloadGameStateを追加）
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## ショーダウン時のチップ配当計算が間違っている
- [x] handleShowdown関数のポット分配ロジックを確認
- [x] サイドポット計算ロジックを確認
- [x] チップ総数が保存されているか確認
- [x] 根本原因を特定して修正（calculatePots関数ですべてのプレイヤーを次のポットから除外するように修正）
- [x] GitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でブラウザテストを実施

## calculatePots修正後もチップの合計が正しくない
- [x] 実際のゲームデータ（ベット額、ポット）を確認
- [x] calculatePots関数のロジックを再確認
- [x] テストケースを追加して問題を再現
- [x] 根本原因を特定: オールイン時のuncalled bet返金とfolded扱いの不統一

## サイドポット計算とオールイン時のチップ消失バグ修正
- [x] calculatePots関数を修正: eligiblePlayers.length === 1 のポットを返金として扱う
- [x] handleShowdown関数を修正: foldedプレイヤーのベットを正しく集計
- [x] 不変条件チェックを追加: sumChipsAfter = sumChipsBefore + refundTotal + distributedTotal - sumTotalBet
- [x] ログ出力を追加: sumChipsBefore, sumChipsAfter, sumTotalBet, refundTotal, distributedTotal
- [x] GitHubにプッシュしてHerokuにデプロイ
- [x] 本番環境でブラウザテストを実施

## ショーダウン画面でポットが0と表示される問題
- [x] 実際のデータを確認: handleShowdown後にgame.potが0にリセットされるため
- [x] フロントエンドを修正: ショーダウン画面でwinnersのamount合計を表示
- [x] 修正をGitHubにプッシュしてHerokuにデプロイ (commit a6f33d2)
- [x] ブラウザで実際のゲームをテストして修正を検証（4ショーダウン、全て正常）

## AIプレイヤーが頻繁にフォールドしてショーダウンに到達しない問題
- [x] AIプレイヤーのロジックを調査してフォールド頻度が高い原因を特定
- [x] AIプレイヤーのロジックを修正してショーダウン到達率を向上
- [x] 修正をGitHubにプッシュしてHerokuにデプロイ (commit 3f2e2ab)
- [ ] 本番環境で100ショーダウンテストを実施して修正を検証

## AIプレイヤー自動追加機能の改善
- [x] addAIのデフォルト値をtrueに変更
- [x] aiCountのデフォルト値を5に変更
- [ ] 修正をGitHubにプッシュしてHerokuにデプロイ
- [ ] 本番環境でテストして動作確認
